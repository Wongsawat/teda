# Database-Backed TISI City Names

Successfully converted the JAXB-generated `TISI1099CityName` interface to a database-backed implementation using existing SQL scripts.

## Overview

**Original:** String-based interface generated by JAXB
**New:** Database-backed entity with full JAXB marshalling/unmarshalling support
**Data Source:** Existing `tisi_city_name.sql` and `tisi_city_name_data.sql`

## Created Files

### 1. JPA Entity
**File:** `src/main/java/com/wpanther/etax/entity/TISICityName.java`

```java
@Entity
@Table(name = "tisi_city_name")
public class TISICityName {
    private String code;           // "1001", "5001", etc. (4 digits)
    private String nameTh;         // "เขตพระนคร", "เมืองเชียงใหม่"
    private String provinceCode;   // First 2 digits (computed)
    private String districtCode;   // Last 2 digits (computed)
}
```

### 2. Spring Data Repository
**File:** `src/main/java/com/wpanther/etax/repository/TISICityNameRepository.java`

```java
@Repository
public interface TISICityNameRepository extends JpaRepository<TISICityName, String> {
    Optional<TISICityName> findByCode(String code);
    List<TISICityName> findByProvinceCode(String provinceCode);
    List<TISICityName> findByNameThContaining(String name);
}
```

### 3. JAXB XmlAdapter
**File:** `src/main/java/com/wpanther/etax/adapter/TISICityNameAdapter.java`

```java
@Component
public class TISICityNameAdapter extends XmlAdapter<String, TISICityName> {
    @Override
    public String marshal(TISICityName entity) {
        return entity != null ? entity.getCode() : null;
    }

    @Override
    public TISICityName unmarshal(String code) {
        return repository.findByCode(code)
                .orElseGet(() -> createPlaceholder(code));
    }
}
```

### 4. Custom JAXB Type
**File:** `src/main/java/com/wpanther/etax/xml/city/TISI1099CityNameType.java`

```java
@XmlType(name = "TISI1099CityName",
         namespace = "urn:un:unece:uncefact:identifierlist:standard:CityNameFromTISI1099_2548")
public class TISI1099CityNameType {
    @XmlValue
    @XmlJavaTypeAdapter(TISICityNameAdapter.class)
    private TISICityName value;
}
```

### 5. Namespace Configuration
**File:** `src/main/java/com/wpanther/etax/xml/city/package-info.java`

Preserves exact namespace: `urn:un:unece:uncefact:identifierlist:standard:CityNameFromTISI1099_2548`

### 6. Database Schema
**File:** `tisi_city_name.sql` (existing)

- Table: `tisi_city_name`
- Computed columns: `province_code`, `district_code`
- Indexes on: name_th, province_code, district_code
- Trigger: Auto-update `updated_at` timestamp

### 7. Sample Data
**File:** `tisi_city_name_data.sql` (existing)

**958 Thai Cities/Districts** loaded

## Database Statistics

**Total Cities:** 958

### Sample by Province

| Province Code | Province | City Count | Examples |
|---------------|----------|------------|----------|
| 10 | Bangkok | 50 | เขตพระนคร (1001), เขตดุสิต (1002) |
| 50 | Chiang Mai | 25 | เมืองเชียงใหม่ (5001) |
| 30 | Nakhon Ratchasima | 32 | เมืองนครราชสีมา (3001) |
| 80 | Nakhon Si Thammarat | 23 | เมืองนครศรีธรรมราช (8001) |

### Code Structure

**4-digit format:** `PPDD`
- **PP** = Province code (first 2 digits)
- **DD** = District code (last 2 digits)

**Examples:**
- `1001` = Province 10 (Bangkok), District 01 (Phra Nakhon)
- `5001` = Province 50 (Chiang Mai), District 01 (Mueang)
- `8001` = Province 80 (Nakhon Si Thammarat), District 01 (Mueang)

## Comparison: Before vs After

### Before (Generated Interface)

```java
// TISI1099CityName is just an interface
public interface TISI1099CityName {
    String getValue();
    void setValue(String value);
}

// Usage requires implementation class
TISI1099CityNameImpl city = new TISI1099CityNameImpl();
city.setValue("1001");
// Just a String - no metadata
```

- ❌ No database storage
- ❌ No Thai name
- ❌ No province/district breakdown
- ❌ No validation
- ✅ Simple String value

### After (Database-Backed)

```java
TISICityName bangkok = repository.findByCode("1001").get();
TISI1099CityNameType city = TISI1099CityNameType.of(bangkok);
// Full entity with metadata
```

- ✅ Database storage (958 cities)
- ✅ Thai name: "เขตพระนคร"
- ✅ Province code: "10" (Bangkok)
- ✅ District code: "01" (Phra Nakhon)
- ✅ Full JAXB compatibility

## Usage Examples

### Marshal to XML

```java
TISICityName city = repository.findByCode("1001").get();
TISI1099CityNameType cityType = TISI1099CityNameType.of(city);

JAXBContext context = JAXBContext.newInstance(TISI1099CityNameType.class);
Marshaller marshaller = context.createMarshaller();
marshaller.marshal(cityType, System.out);
```

**Output:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<thcity:TISI1099CityName xmlns:thcity="urn:un:unece:uncefact:identifierlist:standard:CityNameFromTISI1099_2548">
    1001
</thcity:TISI1099CityName>
```

### Unmarshal from XML

```java
String xml = "<TISI1099CityName>5001</TISI1099CityName>";

JAXBContext context = JAXBContext.newInstance(TISI1099CityNameType.class);
Unmarshaller unmarshaller = context.createUnmarshaller();
TISI1099CityNameType cityType =
    (TISI1099CityNameType) unmarshaller.unmarshal(new StringReader(xml));

// Access database-backed entity
System.out.println(cityType.getNameTh());        // "เมืองเชียงใหม่"
System.out.println(cityType.getProvinceCode());  // "50"
System.out.println(cityType.getDistrictCode());  // "01"
```

### Query by Province

```java
// Get all Bangkok districts (province code 10)
List<TISICityName> bangkokDistricts = repository.findByProvinceCode("10");
// Returns 50 Bangkok districts

// Get all Chiang Mai districts (province code 50)
List<TISICityName> chiangMaiDistricts = repository.findByProvinceCode("50");
// Returns 25 Chiang Mai districts
```

### Search by Name

```java
// Search Thai name
List<TISICityName> results = repository.findByNameThContaining("เมือง");
// Returns all cities with "เมือง" (city/mueang) in name
```

## Benefits

✅ **Rich Metadata**
- Thai names for all 958 cities/districts
- Province code (first 2 digits)
- District code (last 2 digits)

✅ **Database Flexibility**
- Update city data via SQL
- No code regeneration needed
- Query by province, name, etc.

✅ **Full JAXB Compatibility**
- Exact namespace preservation
- Same XML structure as generated code
- Seamless marshalling/unmarshalling

✅ **Production Ready**
- Indexed for performance
- Auto-computed province/district codes
- Audit timestamps
- Province-based queries

## Architecture

```
XML Document
    ↕ (JAXB Marshal/Unmarshal)
TISI1099CityNameType
    ↕ (@XmlJavaTypeAdapter)
TISICityNameAdapter
    ↕ (Database Query)
TISICityName (JPA Entity)
    ↕ (Spring Data JPA)
PostgreSQL Database (958 cities)
```

## Database Setup

```bash
# Create table (already done)
psql -U postgres -d etax -f tisi_city_name.sql

# Load data (already done - 958 cities)
psql -U postgres -d etax -f tisi_city_name_data.sql

# Verify
psql -U postgres -d etax -c "SELECT COUNT(*) FROM tisi_city_name;"
# Result: 958 cities
```

## Sample Cities

### Bangkok (Province 10) - 50 districts
- 1001 = เขตพระนคร (Phra Nakhon)
- 1002 = เขตดุสิต (Dusit)
- 1003 = เขตหนองจอก (Nong Chok)
- 1004 = เขตบางรัก (Bang Rak)
- ... (46 more)

### Chiang Mai (Province 50) - 25 districts
- 5001 = เมืองเชียงใหม่ (Mueang Chiang Mai)
- 5002 = จอมทอง (Chom Thong)
- 5003 = แม่แจ่ม (Mae Chaem)
- ... (22 more)

### Phuket (Province 83) - 3 districts
- 8301 = เมืองภูเก็ต (Mueang Phuket)
- 8302 = กะทู้ (Kathu)
- 8303 = ถลาง (Thalang)

## Build Status

✅ **Compilation:** SUCCESS
✅ **Database:** 958 cities loaded
✅ **Package:** com.wpanther.etax.xml.city

## Pattern Applied

This implementation follows the exact same pattern as province codes:
1. JPA Entity for database storage
2. Spring Data Repository for queries
3. XmlAdapter for XML ↔ Database conversion
4. Custom JAXB type with @XmlJavaTypeAdapter
5. Namespace configuration in package-info.java

## Files Summary

```
Created:
├── src/main/java/com/wpanther/etax/
│   ├── entity/TISICityName.java
│   ├── repository/TISICityNameRepository.java
│   ├── adapter/TISICityNameAdapter.java
│   └── xml/city/
│       ├── TISI1099CityNameType.java
│       └── package-info.java

Existing (used):
├── tisi_city_name.sql (schema)
└── tisi_city_name_data.sql (958 cities)
```

## Usage in e-Tax Invoice

This city name type is used in `TradeAddressType` for invoice addresses:

```java
@XmlType(name = "TradeAddressType")
public interface TradeAddressType {
    TISI1099CityName getCityName();  // Now database-backed!
}
```

## Next Steps

1. ✅ Database created and loaded (958 cities)
2. ✅ Build SUCCESS
3. ⏭️ Test with invoice address generation
4. ⏭️ Apply same pattern to TISICitySubDivisionName (8,940+ values)

---

**Status:** ✅ Complete - 958 cities loaded and ready to use
